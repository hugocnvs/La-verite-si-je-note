{% extends "base.html" %}
{% block title %}Explorer les films{% endblock %}

{% block content %}
<section class="filters-inline">
    <form method="get" class="filters-form" id="filters-form">
        <label class="search">
            <span>Recherche instantanée</span>
            <input type="text" name="q" value="{{ selected_query }}" placeholder="Tapez pour filtrer en direct">
        </label>
        <div class="tags-filter">
            <span>Tags</span>
            <div class="dropdown-container">
                <button type="button" class="dropdown-toggle" id="tags-toggle">
                    <span class="dropdown-text">
                        {% if selected_tags %}
                        {{ selected_tags|length }} tag(s) sélectionné(s)
                        {% else %}
                        Sélectionner des tags
                        {% endif %}
                    </span>
                    <span class="dropdown-arrow">▼</span>
                </button>
                <div class="dropdown-menu" id="tags-menu">
                    <div class="dropdown-actions">
                        <button type="button" class="dropdown-action" id="select-all-tags">Tout sélectionner</button>
                        <button type="button" class="dropdown-action" id="deselect-all-tags">Tout
                            désélectionner</button>
                    </div>
                    {% for tag in tags %}
                    <label class="dropdown-item">
                        <input type="checkbox" name="tags" value="{{ tag.name }}" {% if tag.name in selected_tags
                            %}checked{% endif %}>
                        <span>{{ tag.name }}</span>
                    </label>
                    {% endfor %}
                </div>
            </div>
        </div>
        <div class="filter-actions">
            <button type="submit" class="btn">Filtrer</button>
            <a href="/films" class="btn ghost">Réinitialiser</a>
        </div>
    </form>
</section>

<section class="grid" id="films-grid">
    {% include "films/_cards.html" %}
</section>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        // Use event delegation for better performance and to handle dynamic content if any
        document.getElementById('films-grid').addEventListener('submit', async (e) => {
            if (e.target.matches('.watchlist-toggle-form')) {
                e.preventDefault();
                const form = e.target;
                const btn = form.querySelector('button');
                const originalText = btn.innerText;
                const card = form.closest('.film-card');

                // Disable button
                btn.disabled = true;

                try {
                    const response = await fetch(form.action, {
                        method: 'POST',
                        headers: {
                            'Accept': 'application/json'
                        }
                    });

                    if (response.ok) {
                        const data = await response.json();
                        if (data.success) {
                            // Update UI based on action
                            if (data.action === 'added') {
                                btn.innerText = 'Retirer';
                                btn.classList.add('ghost');
                                card.classList.add('is-watchlisted');

                                // Add badge if not present
                                if (!card.querySelector('.watchlist-badge')) {
                                    const link = card.querySelector('a');
                                    const badge = document.createElement('span');
                                    badge.className = 'watchlist-badge';
                                    badge.innerText = '★';
                                    link.appendChild(badge);
                                }
                            } else {
                                btn.innerText = '+ Ajouter';
                                btn.classList.remove('ghost');
                                card.classList.remove('is-watchlisted');

                                // Remove badge
                                const badge = card.querySelector('.watchlist-badge');
                                if (badge) badge.remove();
                            }

                            // Update header counter
                            const headerLink = document.querySelector('nav a[href="/watchlist"]');
                            if (headerLink) {
                                const match = headerLink.innerText.match(/\((\d+)\)/);
                                if (match) {
                                    let count = parseInt(match[1]);
                                    if (data.action === 'added') {
                                        count++;
                                    } else {
                                        count = Math.max(0, count - 1);
                                    }
                                    headerLink.innerText = `Ma watchlist (${count})`;
                                }
                            }
                        }
                    } else {
                        throw new Error('Network response was not ok');
                    }
                } catch (error) {
                    console.error('Error:', error);
                    alert('Une erreur est survenue lors de la mise à jour de votre watchlist.');
                } finally {
                    btn.disabled = false;
                }
            }
        });
    });
</script>
{% endblock %}